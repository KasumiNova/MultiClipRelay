name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Install system deps (GTK/GLib)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            libdbus-1-dev \
            libglib2.0-dev \
            libgtk-4-dev

      - name: Build release binaries
        run: cargo build --release -p relay -p node -p ui-gtk -p ui-tray

      - name: Create tarball
        id: tar
        shell: bash
        run: |
          set -euo pipefail
          ver="${GITHUB_REF_NAME#v}"
          outdir="dist/release"
          pkg="multicliprelay-${ver}-x86_64-linux"
          rm -rf "$outdir" && mkdir -p "$outdir/$pkg"
          install -m 0755 target/release/relay   "$outdir/$pkg/multicliprelay-relay"
          install -m 0755 target/release/node    "$outdir/$pkg/multicliprelay-node"
          install -m 0755 target/release/ui-gtk  "$outdir/$pkg/multicliprelay-ui-gtk"
          install -m 0755 target/release/ui-tray "$outdir/$pkg/multicliprelay-ui-tray"
          # Ship packaging assets, but only the MultiClipRelay ones.
          mkdir -p \
            "$outdir/$pkg/packaging/common/systemd" \
            "$outdir/$pkg/packaging/deb" \
            "$outdir/$pkg/packaging/arch"
          cp packaging/README.md "$outdir/$pkg/packaging/README.md"
          cp packaging/deb/build_deb.sh "$outdir/$pkg/packaging/deb/build_deb.sh"
          cp packaging/arch/PKGBUILD "$outdir/$pkg/packaging/arch/PKGBUILD"
          cp packaging/common/multicliprelay-ui-gtk.desktop  "$outdir/$pkg/packaging/common/multicliprelay-ui-gtk.desktop"
          cp packaging/common/multicliprelay-ui-tray.desktop "$outdir/$pkg/packaging/common/multicliprelay-ui-tray.desktop"
          cp packaging/common/ui.toml.example "$outdir/$pkg/packaging/common/ui.toml.example"
          cp packaging/common/systemd/multicliprelay-relay.service    "$outdir/$pkg/packaging/common/systemd/multicliprelay-relay.service"
          cp packaging/common/systemd/multicliprelay-wl-watch.service "$outdir/$pkg/packaging/common/systemd/multicliprelay-wl-watch.service"
          cp packaging/common/systemd/multicliprelay-wl-apply.service "$outdir/$pkg/packaging/common/systemd/multicliprelay-wl-apply.service"
          cp packaging/common/systemd/multicliprelay.env.example "$outdir/$pkg/packaging/common/systemd/multicliprelay.env.example"
          cp README.md "$outdir/$pkg/README.md"
          (cd "$outdir" && tar -czf "${pkg}.tar.gz" "$pkg")
          echo "path=$outdir/${pkg}.tar.gz" >> "$GITHUB_OUTPUT"

      - name: Upload tarball artifact (for AUR)
        uses: actions/upload-artifact@v4
        with:
          name: multicliprelay-tarball
          path: ${{ steps.tar.outputs.path }}

      - name: Build .deb
        id: deb
        shell: bash
        run: |
          set -euo pipefail
          ver="${GITHUB_REF_NAME#v}"
          chmod +x packaging/deb/build_deb.sh
          packaging/deb/build_deb.sh "$ver"
          echo "path=dist/deb/multicliprelay_${ver}_amd64.deb" >> "$GITHUB_OUTPUT"

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ steps.tar.outputs.path }}
            ${{ steps.deb.outputs.path }}

  aur:
    name: Publish to AUR (binary)
    needs: linux
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
    steps:
      - name: Install tools
        shell: bash
        run: |
          set -euo pipefail
          pacman -Syu --noconfirm --needed git openssh curl

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download tarball artifact
        uses: actions/download-artifact@v4
        with:
          name: multicliprelay-tarball
          path: dist/release

      - name: Update AUR repo
        shell: bash
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          ver="${GITHUB_REF_NAME#v}"
          pkgname="multicliprelay-bin"

          # AUR tooling policy: `makepkg` refuses to run as root.
          # The archlinux:base-devel container runs as root by default, so we
          # create an unprivileged user for all AUR repo operations.
          if ! id -u builder >/dev/null 2>&1; then
            useradd -m -U builder
          fi
          home="/home/builder"

          # Ensure the checked-out workspace is writable by builder.
          if [[ -n "${GITHUB_WORKSPACE:-}" && -d "${GITHUB_WORKSPACE}" ]]; then
            chown -R builder:builder "${GITHUB_WORKSPACE}"
          fi

          tarball="dist/release/multicliprelay-${ver}-x86_64-linux.tar.gz"
          if [[ ! -f "$tarball" ]]; then
            echo "tarball not found: $tarball" >&2
            ls -la dist/release >&2 || true
            exit 1
          fi
          sha256="$(sha256sum "$tarball" | awk '{print $1}')"

          # Setup SSH for AUR push
          install -d -m 700 "$home/.ssh"
          printf '%s\n' "$AUR_SSH_PRIVATE_KEY" > "$home/.ssh/id_ed25519"
          chmod 600 "$home/.ssh/id_ed25519"
          : > "$home/.ssh/known_hosts"
          chmod 644 "$home/.ssh/known_hosts"
          chown -R builder:builder "$home/.ssh"

          # Preload AUR host keys to avoid interactive prompts.
          ssh-keyscan -t ed25519,rsa aur.archlinux.org | tee -a "$home/.ssh/known_hosts" >/dev/null
          # Log what we have (useful when debugging CI failures).
          ssh-keygen -F aur.archlinux.org -f "$home/.ssh/known_hosts" || true

          # Clone AUR repo
          rm -rf aur
          runuser -u builder -- bash -euo pipefail -c "
            export HOME=\"$home\";
            export GIT_SSH_COMMAND=\"ssh -i $home/.ssh/id_ed25519 -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes -o UserKnownHostsFile=$home/.ssh/known_hosts\";

            git clone \"ssh://aur@aur.archlinux.org/${pkgname}.git\" aur;

            # Render PKGBUILD from template
            tpl=\"packaging/arch/PKGBUILD.bin.in\";
            if [[ ! -f \"$tpl\" ]]; then
              echo \"missing template: $tpl\" >&2;
              exit 1;
            fi;
            sed -e \"s/@PKGVER@/${ver}/g\" -e \"s/@SHA256@/${sha256}/g\" \"$tpl\" > aur/PKGBUILD;

            # Generate .SRCINFO (must not run as root)
            (cd aur && makepkg --printsrcinfo > .SRCINFO);

            # Commit & push (no-op if unchanged)
            cd aur;
            git config user.name \"github-actions\";
            git config user.email \"github-actions@github.com\";

            if git diff --quiet; then
              echo \"AUR repo already up to date.\";
              exit 0;
            fi;

            git add PKGBUILD .SRCINFO;
            git commit -m \"multicliprelay-bin: update to v${ver}\";
            git push;
          "
