name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Install system deps (GTK/GLib)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            libdbus-1-dev \
            libglib2.0-dev \
            libgtk-4-dev

      - name: Build release binaries
        run: cargo build --release -p relay -p node -p ui-gtk -p ui-tray

      - name: Create tarball
        id: tar
        shell: bash
        run: |
          set -euo pipefail
          ver="${GITHUB_REF_NAME#v}"
          outdir="dist/release"
          pkg="multicliprelay-${ver}-x86_64-linux"
          rm -rf "$outdir" && mkdir -p "$outdir/$pkg"
          install -m 0755 target/release/relay   "$outdir/$pkg/multicliprelay-relay"
          install -m 0755 target/release/node    "$outdir/$pkg/multicliprelay-node"
          install -m 0755 target/release/ui-gtk  "$outdir/$pkg/multicliprelay-ui-gtk"
          install -m 0755 target/release/ui-tray "$outdir/$pkg/multicliprelay-ui-tray"
          # Ship packaging assets, but only the MultiClipRelay ones.
          mkdir -p \
            "$outdir/$pkg/packaging/common/systemd" \
            "$outdir/$pkg/packaging/deb" \
            "$outdir/$pkg/packaging/arch"
          cp packaging/README.md "$outdir/$pkg/packaging/README.md"
          cp packaging/deb/build_deb.sh "$outdir/$pkg/packaging/deb/build_deb.sh"
          cp packaging/arch/PKGBUILD "$outdir/$pkg/packaging/arch/PKGBUILD"
          cp packaging/common/multicliprelay-ui-gtk.desktop  "$outdir/$pkg/packaging/common/multicliprelay-ui-gtk.desktop"
          cp packaging/common/multicliprelay-ui-tray.desktop "$outdir/$pkg/packaging/common/multicliprelay-ui-tray.desktop"
          cp packaging/common/ui.toml.example "$outdir/$pkg/packaging/common/ui.toml.example"
          cp packaging/common/systemd/multicliprelay-relay.service    "$outdir/$pkg/packaging/common/systemd/multicliprelay-relay.service"
          cp packaging/common/systemd/multicliprelay-wl-watch.service "$outdir/$pkg/packaging/common/systemd/multicliprelay-wl-watch.service"
          cp packaging/common/systemd/multicliprelay-wl-apply.service "$outdir/$pkg/packaging/common/systemd/multicliprelay-wl-apply.service"
          cp packaging/common/systemd/multicliprelay.env.example "$outdir/$pkg/packaging/common/systemd/multicliprelay.env.example"
          cp README.md "$outdir/$pkg/README.md"
          (cd "$outdir" && tar -czf "${pkg}.tar.gz" "$pkg")
          echo "path=$outdir/${pkg}.tar.gz" >> "$GITHUB_OUTPUT"

      - name: Build .deb
        id: deb
        shell: bash
        run: |
          set -euo pipefail
          ver="${GITHUB_REF_NAME#v}"
          chmod +x packaging/deb/build_deb.sh
          packaging/deb/build_deb.sh "$ver"
          echo "path=dist/deb/multicliprelay_${ver}_amd64.deb" >> "$GITHUB_OUTPUT"

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ steps.tar.outputs.path }}
            ${{ steps.deb.outputs.path }}
